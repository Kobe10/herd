<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport"
    content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
  <meta name="description" content="究竟谁能脱颖而出，摘得市级决赛的桂冠？" />
  <link rel="stylesheet" href="./style/home.css" />
  <title>《浙江诗词大会》市级决赛今日正式开赛！</title>
</head>
<style>
</style>

<body>
  <img id="imgForShare" style="position: fixed; left: -1000%; top: -1000%;"
    src="http://x0.ifengimg.com/cmpp/2020_31/eca1633215d8a82_size62_w300_h300.png" alt="分享缩略图" />
  <div id="ifeng_share_thumbnail" style="display:none"></div>
  <div id="ifeng_share_title" style="display:none"></div>
  <div id="ifeng_share_description" style="display:none"></div>
  <div id="ifeng_share_url" style="display:none"></div>
  <div class="college">
    <div class="bg_index"></div>
    <div id="timer"></div>
    <div id="warring"></div>
    <div class="index_bg">

      <div class="title">
      </div>
      <div class="pre">上一题</div>
      <div class="next">下一题</div>
      <div class="submit_answer">提交答案</div>
    </div>
    <div class="suess">恭喜您答对了<span>13</span>题</div>
    <div class="timer_ti">答题用时<span></span></div>
    <div class="shengcheng">点击生成个人成绩单</div>
    <div class="error_index" style="display:none">

    </div>

  </div>
  <div class="tc"></div>
  <div class="tmtc">
    <p>答案提交后将无法修改，是否决定提交您的答案</p>
    <span class="qr">确认</span>
    <span class="jxdt">继续答题</span>
  </div>
  <script src="https://p2.ifengimg.com/l/2018/27/61a49b087c93575/jquery-1.7.2.min.js"></script>
  <script src="https://res.wx.qq.com/open/js/jweixin-1.2.0.js"></script>
  <script>
    var shareIcon = document.getElementById('imgForShare').src,
      shareTitle = '《浙江诗词大会》市级决赛今日正式开赛！',
      shareContent = document.querySelector('meta[name=description]') ? document.querySelector('meta[name=description]')
      .getAttribute('content') : '究竟谁能脱颖而出，摘得市级决赛的桂冠？',
      shareLink = window.location.href;
    document.getElementById("ifeng_share_title").innerHTML = shareTitle;
    document.getElementById("ifeng_share_thumbnail").innerHTML = shareIcon;
    document.getElementById("ifeng_share_description").innerHTML = shareContent;
    document.getElementById("ifeng_share_url").innerHTML = shareLink;
    if (/MicroMessenger/.test(navigator.userAgent)) {
      var wxConfigParams = {};
      $.ajax({
        url: 'https://api.cmpp.v.ifeng.com/api/Secert',
        type: 'get',
        dataType: 'jsonp',
        data: {
          url: encodeURIComponent(window.location.href),
          _: '',
          rt: 'jsonp',
        },
        success: function (data) {
          wxConfigParams.debug = false;
          wxConfigParams.appId = data.data.appId;
          wxConfigParams.timestamp = data.data.timestamp;
          wxConfigParams.nonceStr = data.data.nonceStr;
          wxConfigParams.signature = data.data.signature;
          wxConfigParams.jsApiList = ['onMenuShareAppMessage', 'onMenuShareTimeline', 'onMenuShareQQ',
            'onMenuShareQZone'
          ];
          wx.config(wxConfigParams);
          wx.ready(function () {
            wx.onMenuShareAppMessage({
              title: shareTitle,
              desc: shareContent,
              link: shareLink,
              imgUrl: shareIcon
            });
            wx.onMenuShareQZone({
              title: shareTitle,
              desc: shareContent,
              link: shareLink,
              imgUrl: shareIcon
            });
            wx.onMenuShareQQ({
              title: shareTitle,
              desc: shareContent,
              link: shareLink,
              imgUrl: shareIcon
            });
            wx.onMenuShareTimeline({
              title: shareTitle,
              link: shareLink,
              imgUrl: shareIcon
            });
          });
        },
        error: function (data) {}
      });
    }
  </script>
  <script src="./scripts/common.js"></script>
  <script src="./scripts/login.js"></script>
  <script>
    var datajSON = []

    function submitJson() {
      for (var i = 0; i < 50; i++) {
        datajSON.push({
          isAnswer: 0,
          optionCode: '',
          questionCode: '',
          questionOrderValue: '',
          questionType: '选择',
          userAnswer: ''
        })
      }
      return datajSON
    }
    submitJson()
    console.log(datajSON)
    var curArray = ['A', 'B', 'C', 'D']
    var arr = new Array(50)
    var questionIdVoList = []
    var _index = 0
    //获取题目接口
    $.ajax({
      url: host + "/api/question/random/get",
      type: "post",
      contentType: "application/json",
      dataType: "JSON",
      data: JSON.stringify({
        "competitionCode": sessionStorage.getItem('competitionCode') //
      }),
      success: function (res) {
        if (res.code == 200) {
          console.log(res.data.questionIdVoList)
          sessionStorage.setItem('pageOrderCode', res.data.pageOrderCode)
          questionIdVoList = res.data.questionIdVoList
          questionIdVoList.filter((item, index) => {
            if (item.questionOrderValue) {
              datajSON[index].questionOrderValue = item.questionOrderValue
            }
            if (item.questionCode) {
              datajSON[index].questionCode = item.questionCode
            }
          })
          console.log(datajSON)
          collegeHtml(_index)
          console.log(questionIdVoList)
        } else {
          console.log(res.message)
        }

      }
    })

    var jsonDataAnswer = []
    let college = document.querySelector('.college'),
      index_bg = document.querySelector('.index_bg')

    var next = document.querySelector('.next');
    //题render
    function collegeHtml(_index) {
      if (_index == 0) {
        document.querySelector('.pre').style.display = 'none'
        document.querySelector('.next').style.right = 'auto'
      } else {
        document.querySelector('.pre').style.display = 'block'
        document.querySelector('.next').style.right = 0.94 + 'rem'
      }
      if (_index == questionIdVoList.length - 1) {
        next.style.display = 'none'
        setTimeout(function () {
          document.querySelector('.submit_answer').style.display = 'block'
        }, 500)

      } else {
        document.querySelector('.submit_answer').style.display = 'none'
        next.style.display = 'block'
      }


      var title = ''
      //for (let i = 0; i < questionIdVoList.length; i++) {
      // var odiv = document.createElement('div')
      // index_bg.appendChild(odiv)
      // odiv.className = 'title'
      var title = document.querySelector('.title')
      title.innerHTML = ''
      var ospan = document.createElement('span')
      title.appendChild(ospan)
      var odivp = document.createElement('p')
      title.appendChild(odivp)
      ospan.className = 'num'
      ospan.innerHTML = '第' + questionIdVoList[_index].logicOrderValue + '题'
      odivp.innerHTML = questionIdVoList[_index].questionTitle


      for (let j = 0; j < questionIdVoList[_index].optionDetailVoList.length; j++) {
        // console.log(_index, arr)
        var op = document.createElement('p');
        op.innerHTML = questionIdVoList[_index].optionDetailVoList[j].optionTitle
        op.className = 'choose'
        title.appendChild(op)
        if (!isNaN(arr[_index])) {
          $('.choose').eq(arr[_index]).addClass('cur')
          // op[arr[_index]].className = 'choose cur'
        }

      }
      chooseClick(_index)
      //}
    }



    //选择答案


    function chooseClick(_index) {
      var choose = document.querySelectorAll('.choose');
      for (var i = 0; i < choose.length; i++) {
        choose[i].index = i;

        choose[i].onclick = function () {
          console.log(_index)
          var cur = this.index
          $(this).addClass('cur').siblings().removeClass('cur')
          //datajSON[_index].userAnswer = curArray[cur] //设置abcd
          datajSON[_index].userAnswer = $(this).text()
          datajSON[_index].isAnswer = 1
          datajSON[_index].optionCode = questionIdVoList[_index].optionDetailVoList[cur].optionId
          arr[_index] = cur
          console.log(arr)
          questionIdVoList[_index].answer = cur
          console.log(datajSON)
        }
      }

    }


    //下一题
    var tc = $('.tc');
    next.addEventListener('touchstart', function () {
      if (_index < questionIdVoList.length - 1) {
        if (arr[_index] == null) {
          tc.show()
          tc.html('您还未选择本题答案，请选择！')
          setTimeout(function () {
            tc.hide()
          }, 3000)
        } else {
          _index++;
          collegeHtml(_index)
        }

      }

    })

    //上一题
    var pre = document.querySelector('.pre')
    pre.addEventListener('touchstart', function () {
      if (_index < questionIdVoList.length) {
        _index--;
        collegeHtml(_index)
      }

    })

    //点击提交答案
    var submit_answer = $('.submit_answer');
    submit_answer.click(function () {
      if (arr[arr.length - 1] == null) {
        console.log(arr)
        tc.show()
        tc.html('您还未选择本题答案，请选择！')
        setTimeout(function () {
          tc.hide()
        }, 3000)
      } else {
        $('.tmtc').show()
        $('.qr').click(function () {
          $('.tmtc').hide()
          clearInterval(timer)
          submitAjAX(datajSON)
        })
        $('.jxdt').click(function () { //继续答题
          $('.tmtc').hide()
        })
        // console.log(arr, '提交')
        // console.log(htmlMsg)

      }
    })
    //wx返回按钮事件监听
    console.log(datajSON)
    window.addEventListener("popstate", function (e) {
      $('.tmtc').show()
      $('.qr').click(function () {
        $('.tmtc').hide()
        submitAjAX(datajSON)
      })
      // console.log(datajSON); //根据自己的需求实现自己的功能  
    }, false);

    function pushHistory() {
      var state = {
        title: "title",
        url: "#"
      };
      window.history.pushState(state, "title", "#");
    }
    document.addEventListener("WeixinJSBridgeReady", function () {
      console.log(22)
      WeixinJSBridge.call("showToolbar")
    });
    //提交答案公共方法
    function submitAjAX(data) {
      var parms = {
        "answerInfoReqList": data,
        "pageOrderCode": sessionStorage.getItem('pageOrderCode')
      }
      console.log(parms)
      $.ajax({
        url: host + "/api/question/submit/answer",
        type: "post",
        contentType: "application/json",
        dataType: "JSON",
        data: JSON.stringify(parms),
        success: function (res) {
          if (res.code == 200) {
            console.log(res)
            //提交答案 跳转到生成成绩单页面
            window.location.replace('./report_zong_index.shtml')


            // if (res.data) {
            //   $('.error_index').show();
            //   var h = $(window).height();
            //   console.log(h)
            //   $('.college').css({
            //     "background": 'none',
            //     'height': 'auto',
            //     "background-size": '100%' + h + 'px'
            //   })

            //   $('.suess').show()
            //   $('.timer_ti').show()
            //   $('.shengcheng').show()
            //   $('.index_bg').hide()
            //   $('#timer').hide()
            //   $('.suess span').html(res.data.answerDetailVo.rightQuestionNum)
            //   $('.timer_ti span').html(res.data.answerDetailVo.userTime)

            //   var odivTitle = document.createElement('div')
            //   document.querySelector('.error_index').appendChild(odivTitle)
            //   // odivTitle.innerHTML = '查漏补缺时间'
            //   odivTitle.className = 'tit_cuo';
            //   for (var i = 0; i < res.data.questionAnswerDetailVos.length; i++) {
            //     var odiv = document.createElement('div')
            //     document.querySelector('.error_index').appendChild(odiv)
            //     odiv.className = 'titleError'
            //     var ospan = document.createElement('span')
            //     ospan.className = 'titleError_span'
            //     // console.log(ospan)
            //     odiv.appendChild(ospan)

            //     var op1 = document.createElement('p')
            //     odiv.appendChild(op1)


            //     //rightAnswer  正确答案字段

            //     ospan.innerHTML = '第' + res.data.questionAnswerDetailVos[i].logicOrderValue + '题';
            //     op1.innerHTML = res.data.questionAnswerDetailVos[i].questionTitle;
            //     for (let j = 0; j < res.data.questionAnswerDetailVos[i].optionDetailVoList.length; j++) {
            //       // console.log(_index, arr)
            //       var op = document.createElement('p');
            //       op.innerHTML = res.data.questionAnswerDetailVos[i].optionDetailVoList[j].optionTitle
            //       op.className = 'choose'
            //       if (res.data.questionAnswerDetailVos[i].optionDetailVoList[j].isSelected) {
            //         op.className = 'choose cur red'
            //       }
            //       odiv.appendChild(op)
            //     }
            //     var duiDiv = document.createElement('div')
            //     duiDiv.className = 'proper'
            //     duiDiv.innerHTML = '正确答案 ：' + res.data.questionAnswerDetailVos[i].rightAnswer
            //     odiv.appendChild(duiDiv)


            //   }
            // }
            // console.log(res)
          } else {
            tc.show()
            tc.html(res.message)
            setTimeout(function () {
              tc.hide()
            }, 3000)
          }

        }
      })
    }


    //生成个人成绩单
    var shengcheng = $('.shengcheng');
    shengcheng.click(function () {
      window.location.replace('./report_zong.shtml')
    })

    //倒计时5分钟
    var maxtime = 12 * 60,
      msg, htmlMsg //htmlMsg 时间

    function CountDown() {
      if (maxtime >= 0) {
        minutes = Math.floor(maxtime / 60);
        seconds = Math.floor(maxtime % 60);
        htmlMsg = minutes + "分" + seconds + "秒"
        msg = "剩余时间：" + htmlMsg
        document.all["timer"].innerHTML = msg;
        //if (maxtime == 5 * 60) alert("距离结束仅剩5分钟");
        --maxtime;
      } else {
        clearInterval(timer);
        submitAjAX(datajSON)
        console.log(datajSON)
      }
    }
    timer = setInterval("CountDown()", 1000);
  </script>
</body>

</html>